<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Tron Suit 2.0</title>
    <link rel="stylesheet" type="text/css" href="tronstyle.css">
</head>

<body>
    <h1>Tron Suit 2.0 - CVG 2015</h1>
	<input class="button" type="button" value="Compose Message" onclick="location.href='send.html'"/>
	<input class="button" type="button" value="Archives" onclick="location.href='archive.html'"/>
	<br><br>
	<div id="status_div">Buffering...</div>
    <br>
	<div id="points_div">Showing last known data...</div><br>
	Colors Displayed:
	<div class="gradient" id="grad1"></div><br>
Location:
    <div class="boxed" id="map_div" "></div><br>

	CPU Usage:
    <div id="graph_div" style="height: 400px; width: 900px"></div><br>

	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <script src="http://code.highcharts.com/highcharts.js"></script>
</body>

</html>

<script>
lat = 44.861498;
lon =  -93.353114;
    datapoints = 8;
buffering = 0;
    jQuery(function($) {
        var options = {


            chart: {
                renderTo: 'graph_div',
                defaultSeriesType: 'spline',
                height: 400,
                zoomType: 'x',

                events: {
                    load: function() {
                        console.log(this.series[0]);

                        // set up the updating of the chart each second
                        var series = this.series[0];
                        var series2 = this.series[1];

                        setInterval(function() {

                            console.log(series.xAxis.dataMax);

                            jQuery.get('index_live.php', null, function(tsv) {
                                var traffic = [];
                                var traffic2 = [];
                                tsv = tsv.split(/\n/g);
                               for (var row = 0, rows = tsv.length; row < rows; row++) {
                                    var line = tsv[row].split(/\t/g);

                                        x = 1000 * Number(line[0]);
                                        y = Number(line[1]);
                                    y2 = Number(line[2]);

                                    if (line.length == 3) {
									var myLatlng = new google.maps.LatLng(lat + .001*(.5-Math.random()),lon+.001*(.5-Math.random()));
        addMarker(myLatlng);
		
                                        if (series.xAxis.dataMax < x) {
										    document.getElementById("status_div").innerHTML="Suit is Live Streaming";
										    document.getElementById("points_div").innerHTML="Showing live data...";
											if (buffering == datapoints){  //dump entire buffer
											   for (i = 0; i < datapoints-1; i++) {
											series.addPoint([x, y], false, true); //dont redraw
                                            series2.addPoint([x, y2], false, true);
											  }
											}
											
                                            series.addPoint([x, y], false, true); //dont redraw
                                            series2.addPoint([x, y2], true, true);
											
											buffering=0;
                                        }else{
										if (buffering < datapoints){
											buffering++;
											if (buffering>2){
											document.getElementById("status_div").innerHTML="Buffering...";
										    document.getElementById("points_div").innerHTML="Showing last known data...";
												}
											}else{
											document.getElementById("status_div").innerHTML="Buffering... The suit is probably offline.  Maybe look at the archives?";
										    document.getElementById("points_div").innerHTML="Showing last known data...";
											}
										}
										
                                    }
                                }

                            });
                        }, 5000);
                    }
                }
            },
            title: {
                text: 'Tron Live Test v0.1'
            },
            xAxis: {

                title: {
                    text: 'Time'
                },
                type: 'datetime',
                "labels": {
                    "format": "{value:%m-%d-%y<br>%I:%M:%S%p}"
                }
            },
            yAxis: {
                title: {
                    text: 'Number 1'
                },
                plotLines: [{
                    value: 0,
                    width: 1,
                    color: '#808080'
                }]
            },
            tooltip: {
                headerFormat: '<b>{series.name}</b><br>',
                pointFormat: '{point.x:%Y-%m-%d} <br> {point.x:%I:%M:%S %p} <br> {point.y}'
            },
            plotOptions: {
                series: {
                    marker: {
                        enabled: true
                    }
                }
            },
            legend: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'top',
                x: 40,
                y: 100,
                borderWidth: 0,
                width: 300
            },
            series: [{
                name: 'Jacket CPU Usage'
            }, {
                name: 'Disc CPU Usage'
            }]
        };

        jQuery.get('index_live.php', null, function(tsv) {
            var traffic = [];
            var traffic2 = [];
            tsv = tsv.split(/\n/g);
            for (var row = 0, rows = tsv.length; row < rows; row++) {
                var line = tsv[row].split(/\t/g),
                    x = 1000 * Number(line[0]),
                    y = Number(line[1]);
                y2 = Number(line[2]);
                if (line.length == 3) {
                    for (i = 0; i < datapoints; i++) {
                        traffic.push([x, y]);
                        traffic2.push([x, y2]);
                    }
                }
            }

            options.series[0].data = traffic;
            options.series[1].data = traffic2;

            chart = new Highcharts.Chart(options);
        });

    });

    function initialize() {



        markers = [];

        var myLatlng = new google.maps.LatLng(lat,lon);
        var mapOptions = {
            zoom: 14,
            center: myLatlng
        };
        map = new google.maps.Map(document.getElementById('map_div'),
            mapOptions);

        var polyOptions = {
            strokeColor: '#000000',
            strokeOpacity: 0.5,
            strokeWeight: 3
        };
        poly = new google.maps.Polyline(polyOptions);
        poly.setMap(map);

        addMarker(myLatlng);

    }

    google.maps.event.addDomListener(window, 'load', initialize);

    // Add a marker to the map and push to the array.

    function addMarker(location) {
        var marker = new google.maps.Marker({
            position: location,
            map: map
        });
        var path = poly.getPath();

        path.push(marker.position);
        markers.push(marker);

        map.panTo(marker.position);

        if (path.length > datapoints) {
            path.removeAt(markers[0]);
        }
        if (markers.length > datapoints) {
            markers[0].setMap(null);
            markers.shift();
        }

    }
</script>

<script>
    //Google Analytics Stuff
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-61757882-1', 'auto');
    ga('send', 'pageview');
</script>