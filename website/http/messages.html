<html>
<head>
  
    <title>Tron Suit 2.0</title>
    <link rel="stylesheet" type="text/css" href="tronstyle.css">
</head>
	<body>
	Last requested colors :
    <div class="gradient" id="old_gradient"></div>
	
	<br>
		Request a Color (Click to Select):
	<br>
    <div class="gradient" id="new_gradient" onclick="gradientclick()"></div>
    <div>
        <span style="float: left;">
		<input style="width:75px" onclick="mycolor1click()" class="color {hash:true, onImmediateChange:'updateInfo1(this);', pickerClosable:true }" id="myColor1" value="000000">
 		</span>
        <span style="float: right;"> 
  		<input style="width:75px" onclick="mycolor2click()" class="color {hash:true, onImmediateChange:'updateInfo2(this);', pickerClosable:true }" id="myColor2" value="000000">
		</span>
    </div>
    <center><input type="button" value="Request Color" id="sendbutton1" class="button" onclick="submit(this)" /></center>
	<br>
	Send a Message (Click to Type):
    <br>
    <input class="text_input" type="text" id="new_text" name="fname" maxlength="160">
    <br>
   <center><input type="button" value="Send Message" id="sendbutton2" class="button" onclick="submit(this)" /></center>
    <br>Last sent message:
    <br>
    <input class="text_input" type="text" id="old_text" value="Loading..." readonly>
    <br>

    <br>
    <div id="Blame"></div>
    <script type="text/javascript" src="jscolor/jscolor.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
</body>

</html>

<script>
	refresh_rate = 2000;

    sendingcolor = false;
    color1locked = false;
    color2locked = false;
    twocolor = false;
	
	get_messages();
	
    function get_messages() {

        jQuery.get('messages_get.php', null, function(tsv) {
		
			var tsv = tsv.split(/\n/g);

            var line = tsv[0].split(/\t/g);
            var CreatedTime = String(line[0]);
            var user_msg = String(line[1]);
			
            var color1 = line[2];
            var color2 = line[3];

            document.getElementById("Blame").innerHTML = "Blame " + String(line[4]) + " on " + CreatedTime;

            if (color1 == "#000000" || color1 == "#000000") {
                $("#old_gradient").css({
                    'background': 'linear-gradient(to right, rgba(255,0,0,0),rgba(255,0,0,0))'
                });
            } else {
                $("#old_gradient").css({
                    'background': 'linear-gradient(to right, ' + color1 + ' 0%, ' + color2 + ' 100%)'
                });
            }
            document.getElementById("old_text").value = user_msg;
        });
        setTimeout(get_messages , refresh_rate);
    }

    function submit(button) {

		if (button.id == 'sendbutton1'){
			var new_text = '';
			var color1 = '#'+ document.getElementById('myColor1').color;
			var color2 = '#'+ document.getElementById('myColor2').color;
		}
		
		if (button.id == 'sendbutton2'){
			var new_text = $('#new_text').val();
			var color1 = '#000000';
			var color2 = '#000000';
		}
       

        var oldValue = button.value;
        button.setAttribute('disabled', true);
        button.value = 'Submitting...';

        $.post('messages_post.php', {
            new_text: new_text,
			color1: color1,
            color2: color2
        }, function(data) {
            callback(data);
        });

    }

    function callback(data) {
        var result = Number(data);

        if (result > 0) {
            document.getElementById("sendbutton1").value = "Stop Poking!";
			document.getElementById("sendbutton2").value = "Stop Poking!";
            alert("Request ignored, Please slow down");
        }
        setTimeout(function() {
            document.getElementById("sendbutton1").value = "Request Color";
			document.getElementById("sendbutton2").value = "Send Message";
            document.getElementById("sendbutton1").removeAttribute('disabled');
            document.getElementById("sendbutton2").removeAttribute('disabled');
        }, 3000 + (result * 10000))
    }


    function gradientclick() {
        mycolor1click();
        document.getElementById('myColor1').color.showPicker();
    }

    function mycolor1click() {
        sendingcolor = true;
        if (color1locked) {
            twocolor = true;
            color1locked = false;
            color2locked = false;
        }

        if (color2locked == false && twocolor == false) {
            if (document.getElementById("myColor2").value == "#000000") {
                color2locked = true;
            }
        }
    }

    function mycolor2click() {
        sendingcolor = true;
        if (color2locked) {
            twocolor = true;
            color1locked = false;
            color2locked = false;
        }

        if (color1locked == false && twocolor == false) {
            if (document.getElementById("myColor1").value == "#000000") {
                color1locked = true;
            }
        }
    }

    function updateInfo1(color) {
        if (color2locked) {
            document.getElementById('myColor2').color.fromRGB(color.rgb[0], color.rgb[1], color.rgb[2]);
        }
        $("#new_gradient").css({
            'background': 'linear-gradient(to right,  ' + document.getElementById("myColor1").value + ' 0%, ' + document.getElementById("myColor2").value + ' 100%)'
        });
    }

    function updateInfo2(color) {
        if (color1locked) {
            document.getElementById('myColor1').color.fromRGB(color.rgb[0], color.rgb[1], color.rgb[2]);
        }
        $("#new_gradient").css({
            'background': 'linear-gradient(to right,  ' + document.getElementById("myColor1").value + ' 0%, ' + document.getElementById("myColor2").value + ' 100%)'
        });
    }
</script>